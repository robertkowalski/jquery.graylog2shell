/*! jQuery Graylog2 Shell - v0.1.0 - 2012-06-02
* https://github.com/robertkowalski/jquery.graylog2shell
* Copyright (c) 2012 Robert Kowalski; Licensed GPL */
(function(a){var b=function(){var b=this;a.isFunction(b._init)&&b._init.apply(b,arguments)};b.prototype={_init:function(b,c){var d=this,e={};d.defaults=a.fn.shell.defaults,a.extend(!0,e,d.defaults,b),d.options=e,d.$element=a(c),d._setWidthOfInput(),d._bindEventsFromKeyboard(),d.focus()},focus:function(){var a=this;a.$element.find("input").focus()},_setWidthOfInput:function(){var b=a("#shell-container"),c=b.find(".shell-prompt"),d=30,e=b.outerWidth(!1)-c.outerWidth(!1)-d;b.find("input").css("width",e)},_bindEventsFromKeyboard:function(){var b=this,c=a("#shell-container"),d=c.find("input"),e,f,g;d.bind("keyup",function(a){e=a.which,e===13?b._handleEnterPress():e===38&&(f=b.lastCommand,g=d.val(),f&&g!==f&&d.val(f))})},_handleEnterPress:function(){var b=this,c=a("#shell-container"),d=c.find("input"),e=d.val();if(!a.trim(e).length)return;if(e==="clear"){b._clearShell();return}b._processInput(e),b.lastCommand=e,d.val("")},_clearShell:function(){var b=a(".shell-old-input, .shell-wait");b.remove()},_processInput:function(b){var c=this,d=a("#shell"),e=d.find(".shell-command-input"),f=d.find(".shell-prompt").first(),g=d.find(".shell-old-input"),h='<li class="shell-wait"><div class="shell-loading"></div><div>Calculating</div></li>',i='<li><span class="shell-prompt">'+f.text()+"</span>"+'<span class="shell-old-input">'+e.val()+"</span></li>";d.append(h),c._addLine(i),e.attr("disabled","disabled"),c._makeAjaxCall(b)},_makeAjaxCall:function(b){var c=this;a.ajax({type:"POST",url:"analytics/shell",dataType:"json",data:{cmd:b},success:function(a){},error:function(){c._renderCallback({code:"error",reason:"Internal error."})}})},_addLine:function(b){var c=this,d=a("#shell"),e=d.find(".shell-command-input"),f=d.find(".shell-old-input");!f||!f.length?e.parent().parent().prepend(b):f.last().append(b)},_buildResultLine:function(a,b){var c=this;return'<li class="'+a+'">'+c._getTimestamp()+" - "+b+"</li>"},_getTimestamp:function(){var a=this,b=new Date;return a._dateHelper(b.getHours())+":"+a._dateHelper(b.getMinutes())+":"+a._dateHelper(b.getSeconds())},_dateHelper:function(a){var b=+a;return b<10&&(b="0"+b),b},_renderCallback:function(b){var c=this,d,e;if(!b){d=c._buildResultLine("shell-error","Internal error - Undefined result."),c._addLine(d);return}if(b.code&&b.code==="error"){d=c._buildResultLine("shell-error",b.reason),c._addLine(d);return}if(!b.op){c._logToConsole("Found no data.op or other suitable data");return}if(b.op==="findresult"){e=a("#content-inner"),e.html(b.content);return}if(b.code==="success"){var f="Completed in "+b.ms+"ms";switch(b.op){case"count":f+=c._buildCountResult(b.result);break;case"distinct":f+=c._buildDistinctResult(b.result);break;case"distribution":f+=c._buildDistributionResult(b.result)}d=c._buildResultLine("shell-success",f),c._addLine(d)}},_buildCountResult:function(a){var b=this,c=" - Count result: ";return c+b._wrapInSpan("shell-result-string",a)},_buildDistinctResult:function(a){var b=this,c=" - Distinct result: ",d=a.length,e=0,f;if(d===0)c+="No matches.";else for(f in a)c+=a[f],e<d-1&&(c+=","),e++;return b._wrapInSpan("shell-result-string",c)},_buildDistributionResult:function(a){var b=this,c=" - Distribution result: ",d=a.length,e=0,f;if(a.length===0)c+="No matches.";else for(f in a)c+=a[f].distinct+" ("+parseInt(a[f].count,10)+")",e<d-1&&(c+=", "),e++;return b._wrapInSpan("shell-result-string",c)},_wrapInSpan:function(a,b){return'<span class="'+a+'">'+b+"</span>"},_logToConsole:function(a){window.console&&console.log&&console.log(a)}},a.fn.extend({shell:function(c){var d=Array.prototype.slice.call(arguments),e=d.shift();return this.each(function(f,g){var h=a.data(g,"shell")||a.data(g,"shell",new b(c,g));e&&typeof e=="string"&&e.charAt(0)!=="_"&&a.isFunction(h[e])&&h[e].apply(h,d)})}}),a.fn.shell.defaults={}})(jQuery);