/*! jQuery Graylog2 Shell - v0.1.0 - 2012-06-22
* https://github.com/robertkowalski/jquery.graylog2shell
* Copyright (c) 2012 Robert Kowalski; Licensed GPL */
(function(a,b){var c=function(){var b=this;a.isFunction(b._init)&&b._init.apply(b,arguments)};c.prototype={_init:function(b,c){var d=this,e={};d.defaults=a.fn.shell.defaults,a.extend(!0,e,d.defaults,b),d.options=e,d.$element=a(c),d._setWidthOfInput(),d._bindEventsFromKeyboard(),d.focus()},focus:function(){var a=this;a.$element.find("input").focus()},_setWidthOfInput:function(){var b=a("#shell-container"),c=b.find(".shell-prompt"),d=30,e=b.outerWidth(!1)-c.outerWidth(!1)-d;b.find("input").css("width",e)},_bindEventsFromKeyboard:function(){var b=this,c=a("#shell-container"),d=c.find("input"),e,f,g;d.bind("keyup",function(a){e=a.which,e===13?b._handleEnterPress():e===38&&(f=b.lastCommand,g=d.val(),f&&g!==f&&d.val(f))})},_handleEnterPress:function(){var b=this,c=a("#shell-container"),d=c.find("input"),e=d.val();if(!a.trim(e).length)return;if(e==="clear"){b._clearShell();return}b._processInput(e),b.lastCommand=e,d.val("")},_clearShell:function(){var b=a(".shell-old-input, .shell-wait");b.remove()},_processInput:function(b){var c=this,d=a("#shell"),e=d.find("#shell-command-input"),f=d.find(".shell-prompt").first(),g=d.find("#shell-oldinput-container"),h='<div class="shell-wait"><div class="shell-loading"></div><div>Calculating</div></div>',i='<div class="shell-history-line"><span class="shell-prompt">'+f.text()+"&nbsp;</span>"+'<span class="shell-old-input">'+e.val()+"</span></div>",j=c.options.history;d.append(h),j&&g.append(i),e.attr("disabled","disabled"),c._makeAjaxCall(b)},_makeAjaxCall:function(b){var c=this;a.ajax({type:"POST",url:"analytics/shell",dataType:"json",data:{cmd:b},success:function(a){c._renderCallback(a)},error:function(){c._renderCallback({code:"error",reason:"Internal error."})}})},_buildResultLine:function(a,b){var c=this;return'<div class="'+a+'">'+c._getTimestamp()+" - "+b+"</div>"},_getTimestamp:function(){var a=this,b=new Date;return a._dateHelper(b.getHours())+":"+a._dateHelper(b.getMinutes())+":"+a._dateHelper(b.getSeconds())},_dateHelper:function(a){var b=+a;return b<10&&(b="0"+b),b},_renderCallback:function(b){var c=this,d=a("#shell"),e=d.find("#shell-oldinput-container"),f=d.find(".shell-wait"),g=d.find("#shell-command-input"),h=c.options.history,i,j,k;f.remove(),g.attr("disabled",""),e.find(".shell-history-line").length>=15&&(e.find(".shell-history-line").first().remove(),e.find(".shell-history-result-line").first().remove());if(!b){i=c._buildResultLine("shell-error shell-history-result-line","Internal error - Undefined result."),e.append(i);return}if(b.code&&b.code==="error"){i=c._buildResultLine("shell-error shell-history-result-line",b.reason),e.append(i);return}if(!b.op){c._logToConsole("Found no data.op or other suitable data");return}if(b.code==="success"){k="Completed in "+b.ms+"ms";switch(b.op){case"count":k+=c._buildCountResult(b.result);break;case"distinct":k+=c._buildDistinctResult(b.result);break;case"distribution":k+=c._buildDistributionResult(b.result)}if(b.op==="findresult"){j=a("#content-inner"),j.html(b.content);return}i=c._buildResultLine("shell-success shell-history-result-line",k),e.append(i)}},_buildCountResult:function(a){var b=this,c=" - Count result: ";return c+b._wrapInSpan("shell-result-string",a)},_buildDistinctResult:function(a){var b=this,c=" - Distinct result: ",d=a.length,e=0,f=Object.prototype.hasOwnProperty,g;if(d===0)c+="No matches.";else for(g in a)f.call(a,g)&&(c+=a[g],e<d-1&&(c+=","),e++);return b._wrapInSpan("shell-result-string",c)},_buildDistributionResult:function(a){var b=this,c=" - Distribution result: ",d=a.length,e=0,f=Object.prototype.hasOwnProperty,g;if(a.length===0)c+="No matches.";else for(g in a)f.call(a,g)&&(c+=a[g].distinct+" ("+parseInt(a[g].count,10)+")",e<d-1&&(c+=", "),e++);return b._wrapInSpan("shell-result-string",c)},_wrapInSpan:function(a,b){return'<span class="'+a+'">'+b+"</span>"},_logToConsole:function(a){b.console&&console.log&&console.log(a)}},a.fn.extend({shell:function(b){var d=Array.prototype.slice.call(arguments),e=d.shift();return this.each(function(f,g){var h=a.data(g,"shell")||a.data(g,"shell",new c(b,g));e&&typeof e=="string"&&e.charAt(0)!=="_"&&a.isFunction(h[e])&&h[e].apply(h,d)})}}),a.fn.shell.defaults={history:!0}})(jQuery,window);